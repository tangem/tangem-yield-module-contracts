name: Mirror repository

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          echo "Host github.com" >> ~/.ssh/config
          echo "  ServerAliveInterval 30" >> ~/.ssh/config
          echo "  ServerAliveCountMax 5" >> ~/.ssh/config


      - name: Replace commit authors and remove unwanted files
        run: |
          git filter-branch --env-filter '
          export GIT_AUTHOR_NAME="tangem-service"
          export GIT_AUTHOR_EMAIL="gitservice@tangem.com"
          export GIT_COMMITTER_NAME="tangem-service"
          export GIT_COMMITTER_EMAIL="gitservice@tangem.com"
          ' -- --all

          # удалить папку .github и файл .gitignore из всех коммитов
          git filter-branch --force --index-filter '
          git rm -r --cached --ignore-unmatch .github
          git rm --cached --ignore-unmatch .gitignore
          ' -- --all

      - name: Push to target repo
        run: |
          git config --global user.name "tangem-service"
          git config --global user.email "gitservice@tangem.com"

          remote="git@github.com:tangem/tangem-yield-module-contracts.git"
          git push --mirror "$remote"

      - name: Cleanup SSH keys
        if: always()
        run: |
          rm -rf ~/.ssh
